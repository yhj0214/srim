<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: layout(~{::main})}">
<main>
    <!-- 종목 헤더 -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h2 class="mb-2" th:text="${stock.companyName}">삼성전자</h2>
                    <p class="text-muted mb-2">
                        <code th:text="${stock.tickerKrx}">005930</code>
                        <span class="badge bg-primary ms-2" th:text="${stock.market}">KOSPI</span>
                    </p>
                    <p class="mb-0">
                        <small class="text-muted">
                            <i class="bi bi-building"></i> <span th:text="${stock.industry}">전기전자</span>
                            <span th:if="${stock.region}">
                                · <i class="bi bi-geo-alt"></i> <span th:text="${stock.region}">서울</span>
                            </span>
                        </small>
                    </p>
                </div>
                <div class="col-md-4 text-md-end">
                    <a th:href="@{/stocks}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> 목록으로
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- 탭 네비게이션 -->
    <ul class="nav nav-tabs mb-4" id="stockTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" 
                    data-bs-target="#overview" type="button">
                <i class="bi bi-info-circle"></i> 개요
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="financial-tab" data-bs-toggle="tab" 
                    data-bs-target="#financial" type="button">
                <i class="bi bi-graph-up"></i> 재무정보
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="srim-tab" data-bs-toggle="tab" 
                    data-bs-target="#srim" type="button">
                <i class="bi bi-calculator"></i> S-RIM 평가
            </button>
        </li>
    </ul>

    <!-- 탭 컨텐츠 -->
    <div class="tab-content" id="stockTabsContent">
        <!-- 개요 탭 -->
        <div class="tab-pane fade show active" id="overview">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-info-circle"></i> 기본 정보</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <table class="table table-sm">
                                <tr>
                                    <th width="40%">종목코드</th>
                                    <td><code th:text="${stock.tickerKrx}">005930</code></td>
                                </tr>
                                <tr>
                                    <th>회사명</th>
                                    <td th:text="${stock.companyName}">삼성전자</td>
                                </tr>
                                <tr>
                                    <th>시장</th>
                                    <td>
                                        <span class="badge bg-primary" th:text="${stock.market}">KOSPI</span>
                                    </td>
                                </tr>
                                <tr>
                                    <th>업종</th>
                                    <td th:text="${stock.industry}">전기전자</td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <table class="table table-sm">
                                <tr th:if="${stock.listingDate}">
                                    <th width="40%">상장일</th>
                                    <td th:text="${#temporals.format(stock.listingDate, 'yyyy년 MM월 dd일')}">1975년 06월 11일</td>
                                </tr>
                                <tr th:if="${stock.region}">
                                    <th>지역</th>
                                    <td th:text="${stock.region}">서울</td>
                                </tr>
                                <tr th:if="${stock.sector}">
                                    <th>섹터</th>
                                    <td th:text="${stock.sector}">IT</td>
                                </tr>
                                <tr th:if="${stock.sharesOutstanding}">
                                    <th>상장주식수</th>
                                    <td th:text="${#numbers.formatInteger(stock.sharesOutstanding, 0, 'COMMA')} + '주'">5,969,782,550주</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    
                    <div class="alert alert-info mt-3" th:if="${stock.companyId == null}">
                        <i class="bi bi-info-circle"></i> 
                        이 종목의 상세 정보가 아직 등록되지 않았습니다. 
                        <strong>재무정보 탭을 클릭하면 자동으로 데이터를 수집합니다.</strong>
                    </div>
                </div>
            </div>
        </div>

        <!-- 재무정보 탭 -->
        <div class="tab-pane fade" id="financial">
            <div class="card">
                <div class="card-body">
                    <div id="financialTableContainer">
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">로딩중...</span>
                            </div>
                            <p class="mt-3 text-muted">재무 데이터를 불러오는 중입니다...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- S-RIM 평가 탭 -->
        <div class="tab-pane fade" id="srim">
            <!-- 옵션 선택 -->
            <div class="card mb-3">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label"><strong>기준 선택</strong></label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="srimBasis" id="srimYear" value="YEAR" checked>
                                <label class="btn btn-outline-primary" for="srimYear">
                                    <i class="bi bi-calendar"></i> 연간
                                </label>
                                
                                <input type="radio" class="btn-check" name="srimBasis" id="srimQuarter" value="QTR">
                                <label class="btn btn-outline-primary" for="srimQuarter">
                                    <i class="bi bi-calendar3"></i> 분기
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="srimScenario" class="form-label"><strong>시나리오 선택</strong></label>
                            <select class="form-select" id="srimScenario">
                                <option value="0" selected>기준 (0%)</option>
                                <option value="1">보수적 (-10%)</option>
                                <option value="2">매우 보수적 (-20%)</option>
                                <option value="3">비관적 (-30%)</option>
                                <option value="4">극단적 (-50%)</option>
                            </select>
                        </div>
                    </div>
                    <div class="mt-3 text-center">
                        <button class="btn btn-primary btn-lg" onclick="calculateSrim()">
                            <i class="bi bi-calculator"></i> S-RIM 계산하기
                        </button>
                    </div>
                </div>
            </div>

            <!-- 결과 표시 영역 -->
            <div id="srimResultContainer"></div>

            <!-- 차트 영역 -->
            <div class="card mt-3" id="srimChartCard" style="display:none;">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-bar-chart"></i> 시나리오별 적정주가</h5>
                </div>
                <div class="card-body">
                    <canvas id="srimChart" height="80"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        const stockId = /*[[${stock.stockId}]]*/ null;
        const companyId = /*[[${stock.companyId}]]*/ null;
        let currentPeriodType = 'annual';
        let financialDataLoaded = false;
        let srimDataLoaded = false;
        let srimResult = null;
        let srimChart = null;

        // 페이지 로드 시 이벤트 리스너 등록
        document.addEventListener('DOMContentLoaded', function() {
            console.log('=== 페이지 로드 완료 ===');
            console.log('stockId:', stockId);
            console.log('companyId:', companyId);
            
            // 페이지 로드 즉시 연간 재무제표 데이터 호출
            loadFinancialData();
            
            // S-RIM 탭 클릭 이벤트
            const srimTab = document.getElementById('srim-tab');
            if (srimTab) {
                srimTab.addEventListener('shown.bs.tab', function (event) {
                    console.log('=== S-RIM 탭 표시됨 ===');
                    loadSrimData();
                });
            }
            
            // S-RIM 시나리오 변경 이벤트
            const srimScenario = document.getElementById('srimScenario');
            if (srimScenario) {
                srimScenario.addEventListener('change', function() {
                    if (srimResult) {
                        renderSrimResult(srimResult);
                    }
                });
            }
        });

        // 페이지 로드 시 연간 재무제표 데이터 로드
        function loadFinancialData() {
            console.log('=== loadFinancialData 호출 (페이지 로드 시) ===');
            console.log('stockId:', stockId);
            console.log('companyId:', companyId);
            console.log('financialDataLoaded:', financialDataLoaded);
            
            if (!stockId) {
                showFinancialError('종목 정보가 없습니다.');
                return;
            }
            
            if (!financialDataLoaded) {
                console.log('최초 로딩 - 연간 데이터 조회 시작');
                loadAnnualFinancialData();
                financialDataLoaded = true;
            }
        }

        // S-RIM 탭 클릭 시
        function loadSrimData() {
            console.log('=== loadSrimData 호출 ===');
            console.log('companyId:', companyId);
            
            if (!companyId) {
                showSrimError('회사 정보가 아직 등록되지 않았습니다. 재무정보 탭에서 데이터를 먼저 조회해주세요.');
                return;
            }
            
            if (!srimDataLoaded) {
                srimDataLoaded = true;
            }
        }

        // 연간 재무제표 데이터 로드
        function loadAnnualFinancialData() {
            console.log('=== loadAnnualFinancialData 호출 ===');
            console.log('stockId:', stockId);
            
            if (!stockId) {
                console.error('stockId가 없습니다');
                showFinancialError('종목 정보가 없습니다.');
                return;
            }

            currentPeriodType = 'annual';
            showFinancialLoading();

            // stockId 기반 API 호출 (연간만)
            const url = `/api/stocks/${stockId}/financial/annual`;
            console.log('API 호출 URL:', url);
            
            fetch(url)
                .then(response => {
                    console.log('응답 상태:', response.status);
                    console.log('응답 OK:', response.ok);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(result => {
                    console.log('API 응답 데이터:', result);
                    if (result.success) {
                        renderFinancialTable(result.data);
                    } else {
                        showFinancialError(result.message || '재무 데이터를 불러올 수 없습니다.');
                    }
                })
                .catch(error => {
                    console.error('=== API 호출 에러 ===');
                    console.error('Error:', error);
                    console.error('Error message:', error.message);
                    console.error('Error stack:', error.stack);
                    showFinancialError('네트워크 오류가 발생했습니다: ' + error.message);
                });
        }

        // S-RIM 계산
        function calculateSrim() {
            if (!companyId) {
                showSrimError('회사 정보가 아직 등록되지 않았습니다. 재무정보 탭에서 데이터를 먼저 조회해주세요.');
                return;
            }

            const basis = document.querySelector('input[name="srimBasis"]:checked').value;
            showSrimLoading();

            const url = `/api/stocks/${companyId}/srim?basis=${basis}`;
            console.log('S-RIM API 호출:', url);
            
            fetch(url)
                .then(response => response.json())
                .then(result => {
                    console.log('S-RIM 응답:', result);
                    if (result.success) {
                        srimResult = result.data;
                        renderSrimResult(srimResult);
                        renderSrimChart(srimResult);
                    } else {
                        showSrimError(result.message || 'S-RIM 계산에 실패했습니다.');
                    }
                })
                .catch(error => {
                    console.error('S-RIM Error:', error);
                    showSrimError('네트워크 오류가 발생했습니다.');
                });
        }

        // S-RIM 결과 렌더링
        function renderSrimResult(data) {
            const selectedIndex = parseInt(document.getElementById('srimScenario').value);
            const scenario = data.scenarios[selectedIndex];

            const html = `
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="bi bi-calculator"></i> S-RIM 평가 결과</h5>
                    </div>
                    <div class="card-body">
                        <!-- 중간 계산값 -->
                        <h6 class="border-bottom pb-2 mb-3">중간 계산값</h6>
                        <div class="row g-3 mb-4">
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <small class="text-muted">BPS (주당순자산)</small>
                                        <h4 class="mb-0">${formatNumber(data.equity)}원</h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <small class="text-muted">ROE (가중평균)</small>
                                        <h4 class="mb-0">${formatPercent(data.roe)}</h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <small class="text-muted">Ke (할인율)</small>
                                        <h4 class="mb-0">${formatPercent(data.ke)}</h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <small class="text-muted">주식수</small>
                                        <h4 class="mb-0">${formatShares(data.sharesOutstanding)}</h4>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 선택된 시나리오 결과 -->
                        <h6 class="border-bottom pb-2 mb-3">
                            시나리오: ${getScenarioName(selectedIndex)}
                        </h6>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <div class="card border-primary">
                                    <div class="card-body text-center">
                                        <small class="text-muted">적정주가</small>
                                        <h3 class="text-primary mb-0">${formatNumber(scenario.fairValuePerShare)}원</h3>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <small class="text-muted">기업가치</small>
                                        <h5 class="mb-0">${formatBillion(scenario.enterpriseValue)}</h5>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <small class="text-muted">초과이익</small>
                                        <h5 class="mb-0">${formatBillion(scenario.excessEarnings)}</h5>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 모든 시나리오 비교 -->
                        <h6 class="border-bottom pb-2 mt-4 mb-3">시나리오별 비교</h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>시나리오</th>
                                        <th class="text-end">감소율</th>
                                        <th class="text-end">적정주가</th>
                                        <th class="text-end">기업가치</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.scenarios.map((s, i) => `
                                        <tr class="${i === selectedIndex ? 'table-primary' : ''}">
                                            <td><strong>${getScenarioName(i)}</strong></td>
                                            <td class="text-end">${formatReduction(s.reductionRate)}</td>
                                            <td class="text-end"><strong>${formatNumber(s.fairValuePerShare)}원</strong></td>
                                            <td class="text-end">${formatBillion(s.enterpriseValue)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>

                        <div class="alert alert-info mt-3">
                            <small>
                                <i class="bi bi-info-circle"></i>
                                <strong>계산 방식:</strong> 
                                기업가치 = 자기자본 + (초과이익 / Ke), 
                                초과이익 = 자기자본 × (ROE - Ke) × (1 + 감소율)
                            </small>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('srimResultContainer').innerHTML = html;
        }

        // S-RIM 차트 렌더링
        function renderSrimChart(data) {
            const chartCard = document.getElementById('srimChartCard');
            chartCard.style.display = 'block';

            const ctx = document.getElementById('srimChart');
            
            // 기존 차트 삭제
            if (srimChart) {
                srimChart.destroy();
            }

            const labels = data.scenarios.map((s, i) => getScenarioName(i));
            const values = data.scenarios.map(s => parseFloat(s.fairValuePerShare));

            srimChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '적정주가 (원)',
                        data: values,
                        backgroundColor: [
                            'rgba(54, 162, 235, 0.8)',
                            'rgba(75, 192, 192, 0.8)',
                            'rgba(255, 206, 86, 0.8)',
                            'rgba(255, 159, 64, 0.8)',
                            'rgba(255, 99, 132, 0.8)'
                        ],
                        borderColor: [
                            'rgba(54, 162, 235, 1)',
                            'rgba(75, 192, 192, 1)',
                            'rgba(255, 206, 86, 1)',
                            'rgba(255, 159, 64, 1)',
                            'rgba(255, 99, 132, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return '적정주가: ' + context.parsed.y.toLocaleString('ko-KR') + '원';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString('ko-KR');
                                }
                            }
                        }
                    }
                }
            });
        }

        // 시나리오 이름
        function getScenarioName(index) {
            const names = ['기준 (0%)', '보수적 (-10%)', '매우 보수적 (-20%)', '비관적 (-30%)', '극단적 (-50%)'];
            return names[index] || '알 수 없음';
        }

        // 감소율 포맷
        function formatReduction(value) {
            const num = parseFloat(value) * 100;
            return num === 0 ? '0%' : num.toFixed(0) + '%';
        }

        // 숫자 포맷
        function formatNumber(value) {
            if (!value) return '-';
            return parseFloat(value).toLocaleString('ko-KR', {maximumFractionDigits: 0});
        }

        // 퍼센트 포맷
        function formatPercent(value) {
            if (!value) return '-';
            // return (parseFloat(value) * 100).toFixed(2) + '%';
            return (parseFloat(value)).toFixed(2) + '%';
        }

        // 억원 포맷
        function formatBillion(value) {
            if (!value) return '-';
            return (parseFloat(value) / 100000000).toLocaleString('ko-KR', {maximumFractionDigits: 0}) + '억원';
        }

        // 주식수 포맷
        function formatShares(value) {
            if (!value) return '-';
            return (parseFloat(value)) + '주';
        }

        // 로딩/에러 표시 함수들
        function showFinancialLoading() {
            document.getElementById('financialTableContainer').innerHTML = `
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">로딩중...</span>
                    </div>
                    <p class="mt-3 text-muted">재무 데이터를 불러오는 중입니다...</p>
                    <p class="text-muted"><small>데이터가 없으면 자동으로 크롤링을 시작합니다.</small></p>
                </div>
            `;
        }

        function showFinancialError(message) {
            document.getElementById('financialTableContainer').innerHTML = `
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i> ${message}
                </div>
            `;
        }

        function showSrimLoading() {
            document.getElementById('srimResultContainer').innerHTML = `
                <div class="card">
                    <div class="card-body text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">계산중...</span>
                        </div>
                        <p class="mt-3 text-muted">S-RIM을 계산하는 중입니다...</p>
                    </div>
                </div>
            `;
        }

        function showSrimError(message) {
            document.getElementById('srimResultContainer').innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle"></i> ${message}
                </div>
            `;
        }

        // 재무 테이블 렌더링 (모든 년도 표시, 가장 오른쪽이 최신)
        function renderFinancialTable(data) {
            console.log('=== renderFinancialTable 호출 ===');
            console.log('data:', data);
            
            if (!data.headers || data.headers.length === 0) {
                showFinancialError('재무 데이터가 없습니다.');
                return;
            }

            // 헤더를 역순으로 정렬 (가장 오른쪽이 최신)
            const reversedHeaders = [...data.headers].reverse();
            
            console.log(`총 ${reversedHeaders.length}개 기간 데이터 표시 (가장 오른쪽이 최신)`);

            let html = '<div class="table-responsive">';
            html += '<table class="table table-sm table-bordered" style="min-width: 1500px;">';
            
            // 헤더 렌더링 (역순, 너비 증가)
            html += '<thead class="table-light"><tr>';
            html += '<th style="min-width: 200px; width: 200px; white-space: nowrap;">지표</th>';
            reversedHeaders.forEach(header => {
                html += `<th class="text-end" style="min-width: 150px; width: 150px; white-space: nowrap;">${header.label}${header.isEstimate ? '(E)' : ''}</th>`;
            });
            html += '</tr></thead>';
            
            // 데이터 행 렌더링 (역순, 너비 증가)
            html += '<tbody>';
            data.rows.forEach(row => {
                html += '<tr>';
                html += `<td style="min-width: 200px; width: 200px; white-space: nowrap;"><strong>${row.metricName}</strong></td>`;
                reversedHeaders.forEach(header => {
                    const value = row.values[header.periodId];
                    html += `<td class="text-end" style="min-width: 150px; width: 150px; white-space: nowrap;">${formatValue(value, row.unit)}</td>`;
                });
                html += '</tr>';
            });
            html += '</tbody></table></div>';

            document.getElementById('financialTableContainer').innerHTML = html;
            console.log('테이블 렌더링 완료');
        }

        // 값 포맷팅
        function formatValue(value, unit) {
            if (value == null) return '-';
            
            const num = parseFloat(value);
            
            if (unit === 'KRW' || unit === '원') {
                // return (num / 100000000).toLocaleString('ko-KR', {maximumFractionDigits: 0}) + '억';
                return (num).toLocaleString('ko-KR', {maximumFractionDigits: 0}) + '억';
            } else if (unit === '%') {
                // return (num * 100).toFixed(2) + '%';
                return (num).toFixed(2) + '%';
            } else if (unit === '배') {
                return num.toFixed(2) + '배';
            } else {
                return num.toLocaleString('ko-KR', {maximumFractionDigits: 2});
            }
        }
    </script>
</main>
</html>
